#  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#  SPDX-License-Identifier: MIT-0
version: 0.2

env:
  parameter-store:
    GITHUB_TOKEN: "GITHUB_TOKEN"
    EKS_STAG_CLUSTER_NAME: "EKS_STAG_CLUSTER_NAME"
    # DOCKER_PASSWORD: "DOCKER_PASSWORD"
    # DOCKER_USERNAME: "DOCKER_USERNAME"
    # AWS_ACCOUNT_ID: "acc-id"

phases:
  # install:
  #   commands:
  #     - echo "in the install phase"
  #     - curl -sS -o kubectl https://s3.us-west-2.amazonaws.com/amazon-eks/1.25.6/2023-01-30/bin/darwin/amd64/kubectl
  #     - chmod +x ./kubectl
  #   finally:
  #     - echo "This always runs even if the login command fails"     
  pre_build:
    commands:
      - git clone https://nec-msbu-devops:$GITHUB_TOKEN@github.com/nec-msbu-devops/chatbot.git
      - export KUBECONFIG=$HOME/.kube/config
  build:
    commands:
      - cd $CODEBUILD_SRC_DIR
      # - $(aws ecr get-login --no-include-email --region $AWS_DEFAULT_REGION)
  post_build:
    commands:
      - echo "inside post_build .. deploying build"
      - cd chatbot/chatbot/Kubernetes-YAML
      - echo "Setting Environment Variables related to AWS CLI for Kube Config Setup"          
      - CREDENTIALS=$(aws sts assume-role --role-arn arn:aws:iam::925016504071:role/EksCodeBuildKubectlRole --role-session-name codebuild-kubectl --duration-seconds 900)
      - export AWS_ACCESS_KEY_ID="$(echo ${CREDENTIALS} | jq -r '.Credentials.AccessKeyId')"
      - export AWS_SECRET_ACCESS_KEY="$(echo ${CREDENTIALS} | jq -r '.Credentials.SecretAccessKey')"
      - export AWS_SESSION_TOKEN="$(echo ${CREDENTIALS} | jq -r '.Credentials.SessionToken')"
      - export AWS_EXPIRATION=$(echo ${CREDENTIALS} | jq -r '.Credentials.Expiration')
      - aws eks update-kubeconfig --name kx-eks-stage 
      - kubectl config current-context
      - aws sts get-caller-identity
      - kubectl apply -f webserver.yaml
artifacts:     
  type: zip
  files: '**/*'